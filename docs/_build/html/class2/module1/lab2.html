<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>2.1.2. Lab 2: Leverage LTM Policies To Direct SSL Terminated Applications To Secondary Virtual Servers</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="2.1.2. Lab 2: Leverage LTM Policies To Direct SSL Terminated Applications To Secondary Virtual Servers"/>
  <meta name="product" content="F5 Firewall Solutions"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2020-01-28 09:36:45"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 Firewall Solutions" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>2.1.2. Lab 2: Leverage LTM Policies To Direct SSL Terminated Applications To Secondary Virtual Servers &#8212; F5 Firewall Solutions  documentation</title>
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5_agility_theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/CoveoFullSearch.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/21fb8a09c3.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="2.1.3. Lab 3: Configure Local Logging For Firewall Events" href="lab3.html" />
    <link rel="prev" title="2.1.1. Lab 1: Configure pools and internal virtual servers" href="lab1.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 Firewall Solutions  </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../class1/class1.html">1. Class 1: AFM – The Data Center Firewall</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../class2.html">2. Advanced Multi-Layer Firewall Protection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class3/class3.html">3. Class - F5 BIG-IP DDoS and DNS DoS Protections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class4/class4.html">4. Flowmon Integrated Out-of-path DDoS Solution</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">2.1.2. Lab 2: Leverage LTM Policies To Direct SSL Terminated Applications To Secondary Virtual Servers</a><ul>
<li><a class="reference internal" href="#create-the-ltm-policies">2.1.2.1. Create the LTM Policies</a></li>
<li><a class="reference internal" href="#apply-the-policy-to-the-external-virtual-server">2.1.2.2. Apply The Policy To The External Virtual Server</a></li>
<li><a class="reference internal" href="#validate-lab-2-configuration">2.1.2.3. Validate Lab 2 Configuration</a></li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">F5 Firewall Solutions</a>
              &gt; <a href="../class2.html">2. Advanced Multi-Layer Firewall Protection</a>
              &gt; <a href="module1.html">2.1. Module 1: F5 Multi-layer Firewall</a>

          <span class="right">
             <a href="../../_sources/class2/module1/lab2.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/f5devcentral/f5-agility-labs-firewall">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="lab-2-leverage-ltm-policies-to-direct-ssl-terminated-applications-to-secondary-virtual-servers">
<h1>2.1.2. Lab 2: Leverage LTM Policies To Direct SSL Terminated Applications To Secondary Virtual Servers<a class="headerlink" href="#lab-2-leverage-ltm-policies-to-direct-ssl-terminated-applications-to-secondary-virtual-servers" title="Permalink to this headline">¶</a></h1>
<p>What is SNI? Introduced in TLS 1.0 as a TLS extension, Server Name Indication (SNI) allows the client to send the hostname they are trying to connect to in the SSL handshake. This allows the Application Delivery Controllers (ADC) such as the BIG-IP and the Application servers to identify the appropriate application the client is trying to connect to. From this information, the ADC can respond with the proper SSL certificate to the client allowing the ADC to provide SSL enabled services for multiple applications from a single IP address.</p>
<p>LTM policies are another way to programatically modify traffic as it is flowing through the data plane of the BIG-IP. This functionality can also be accomplished with F5 iRules. The advantage this has over iRules is that LTM policies can be modified and appended to the existing configuration without replacing the entire application configuration. This lends itself to being updated through the CLI or via the REST API easily.</p>
<p>If you make a single change to an iRule, the entire iRule needs to be re-uploaded and applied.</p>
<p>The LTM policy is what directs application traffic to flow from the external virtual server to the internal virtual servers based on the Layer 7 request. In this case, since we are using SNI to terminate multiple applications (mysite,yoursite,theirsite, api, downloads) we need to be able to direct that traffic to the appropriate application pools. Some can even come back to the same application pool.</p>
<p>Whether it is based on the hostname or the URI path, the request can be forwarded to a different virtual server or an application pool of servers.</p>
<div class="section" id="create-the-ltm-policies">
<h2>2.1.2.1. Create the LTM Policies<a class="headerlink" href="#create-the-ltm-policies" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As shown in this diagram, there is an external VIP and internal VIPs.  The external VIP has the local traffic policies on it.</p>
</div>
<p><img alt="ltp-diagram" src="../../_images/ltp-diagram.png" /></p>
<p><strong>Navigation:</strong> Local Traffic &gt; Policies : Policy List &gt; Policy List Page,
then click Create</p>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Policy Name</strong></th>
<th class="head">HTTPS_Virtual_Targeting_PolicyL7</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>Strategy</strong></td>
<td>Execute <strong>*best*</strong> matching rule using the <strong>*best-match*</strong> strategy</td>
</tr>
</tbody>
</table>
<p><strong>Navigation:</strong> Click Create Policy</p>
<p><a class="reference internal" href="../../_images/image138.png"><img alt="image11" src="../../_images/image138.png" style="width: 7.08611in; height: 1.97069in;" /></a></p>
<p><strong>Navigation:</strong> Local Traffic &gt; Policies : Policy List &gt; Draft Policies &gt;  /Common/HTTPS_Virtual_Targeting_PolicyL7</p>
<p><a class="reference internal" href="../../_images/image141.png"><img alt="image12" src="../../_images/image141.png" style="width: 7.04167in; height: 2.62500in;" /></a></p>
<p><strong>Navigation:</strong> Click create to create some rules.</p>
<p>You will need to create the following rules within your policy:</p>
<table border="1" class="docutils">
<colgroup>
<col width="35%" />
<col width="13%" />
<col width="12%" />
<col width="10%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head"><strong>Rule Name</strong></th>
<th class="head"><strong>Rule Logic</strong></th>
<th class="head">&#160;</th>
<th class="head">&#160;</th>
<th class="head">&#160;</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>www.mysite.com</td>
<td>HTTP Host</td>
<td>Host</td>
<td>is</td>
<td>www.mysite.com</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>Forward Traffic</td>
<td>Virtual Server</td>
<td>&#160;</td>
<td>int_vip_www.mysite.com_1.1.1.1</td>
</tr>
<tr class="row-even"><td>www.yoursite.com</td>
<td>HTTP Host</td>
<td>Host</td>
<td>is</td>
<td>www.yoursite.com</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>Forward Traffic</td>
<td>Virtual Server</td>
<td>&#160;</td>
<td>int_vip_www.yoursite.com_3.3.3.3</td>
</tr>
<tr class="row-even"><td>www.theirsite.com</td>
<td>HTTP Host</td>
<td>Host</td>
<td>is</td>
<td>www.theirsite.com</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>Forward Traffic</td>
<td>Virtual Server</td>
<td>&#160;</td>
<td>int_vip_www.theirsite.com_2.2.2.2</td>
</tr>
<tr class="row-even"><td>www.mysite.com-api</td>
<td>HTTP Host</td>
<td>host</td>
<td>is</td>
<td>www.mysite.com</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>HTTP URI</td>
<td>path</td>
<td>begins with</td>
<td>/api</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>Forward Traffic</td>
<td>Virtual Server</td>
<td>&#160;</td>
<td>int_vip_www.mysite.com-api_1.1.1.2</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>Replace</td>
<td>http uri</td>
<td>path</td>
<td>with <strong>/</strong></td>
</tr>
<tr class="row-even"><td>www.mysite.com-downloads</td>
<td>HTTP Host</td>
<td>host</td>
<td>is</td>
<td>www.mysite.com</td>
</tr>
<tr class="row-odd"><td>&#160;</td>
<td>HTTP URI</td>
<td>path</td>
<td>begins with</td>
<td>/downloads</td>
</tr>
<tr class="row-even"><td>&#160;</td>
<td>Forward Traffic</td>
<td>Virtual Server</td>
<td>&#160;</td>
<td>int_vip_www.mysite.com-downloads_1.1.1.3</td>
</tr>
</tbody>
</table>
<p><strong>Navigation:</strong> Remember to click Add after adding the matching string</p>
<p><a class="reference internal" href="../../_images/policy_shot.png"><img alt="image13" src="../../_images/policy_shot.png" style="width: 7.04167in; height: 4.02500in;" /></a></p>
<p><strong>Navigation:</strong> Click Save</p>
<p>Additional Example for /api. The replacement line is required to strip
the path from the request for the site to work.</p>
<p><a class="reference internal" href="../../_images/policy2.png"><img alt="image14" src="../../_images/policy2.png" style="width: 7.05000in; height: 4.29861in;" /></a></p>
<p><strong>Complete the additional policies according to the list above.</strong></p>
<p>Once complete, you must save a Draft, then publish the policy.</p>
<p><strong>Navigation:</strong> Local Traffic &gt; Policies: Policy List &gt;
/Common/HTTPS_Virtual_Targeting_PolicyL7</p>
<p><strong>Navigation:</strong> Save Draft
<strong>Navigation:</strong> Click Publish</p>
<p><a class="reference internal" href="../../_images/image171.png"><img alt="image15" src="../../_images/image171.png" style="width: 7.05556in; height: 1.68056in;" /></a></p>
</div>
<div class="section" id="apply-the-policy-to-the-external-virtual-server">
<h2>2.1.2.2. Apply The Policy To The External Virtual Server<a class="headerlink" href="#apply-the-policy-to-the-external-virtual-server" title="Permalink to this headline">¶</a></h2>
<p><strong>Navigation:</strong> Local Traffic &gt; Virtual Servers : Virtual Server List</p>
<p><a class="reference internal" href="../../_images/image181.png"><img alt="image16" src="../../_images/image181.png" style="width: 7.05000in; height: 2.35764in;" /></a></p>
<p><strong>Navigation:</strong> Click the EXT_VIP_10.10.90.30</p>
<p><a class="reference internal" href="../../_images/image191.png"><img alt="image17" src="../../_images/image191.png" style="width: 7.04167in; height: 2.25000in;" /></a></p>
<p><strong>Navigation:</strong> Click the Resources Tab</p>
<p><a class="reference internal" href="../../_images/image201.png"><img alt="image18" src="../../_images/image201.png" style="width: 7.05556in; height: 0.80556in;" /></a></p>
<p><strong>Navigation:</strong> Under Policies Click Manage</p>
<p><a class="reference internal" href="../../_images/image211.png"><img alt="image19" src="../../_images/image211.png" style="width: 7.05556in; height: 3.34722in;" /></a></p>
<p><strong>Navigation:</strong> Select the HTTPS_Virtual_Targeting_PolicyL7</p>
<p><a class="reference internal" href="../../_images/image221.png"><img alt="image20" src="../../_images/image221.png" style="width: 7.04167in; height: 2.56944in;" /></a></p>
<p><strong>Navigation:</strong> Click the Double Arrow to move the policy into the left-hand
column and click Finished.</p>
<p><a class="reference internal" href="../../_images/image231.png"><img alt="image21" src="../../_images/image231.png" style="width: 7.04167in; height: 2.59722in;" /></a></p>
<p>The result should look like the screenshot below.</p>
<p><a class="reference internal" href="../../_images/image241.png"><img alt="image22" src="../../_images/image241.png" style="width: 7.04167in; height: 4.31944in;" /></a></p>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">When you first set up the Virtual Servers, accessing the sites didn’t work very well because the policies were not setup.  Now try accessing all the VS you created from Chrome. You can use the bookmarks for easy access. If you manually type in the sites in the address bar, use <a class="reference external" href="https://**">https://**</a> since you enabled encyrption when you created the virtual server.</p>
</div>
</div>
<div class="section" id="validate-lab-2-configuration">
<h2>2.1.2.3. Validate Lab 2 Configuration<a class="headerlink" href="#validate-lab-2-configuration" title="Permalink to this headline">¶</a></h2>
<p><strong>Validation:</strong> This lab is using self-signed certificates. You can
either open a web browser on the test client or run CURL from the CLI to
validate your configuration.</p>
<p><strong>You will need to accept the certificate to proceed to the application sites</strong></p>
<p><strong>With curl you need to use the -k option to ignore certificate validation</strong></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You may have to edit the hosts file on your Win7 Client to add:</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">10.10.99.30 www.mysite.com</span>

<span class="go">10.10.99.30 www.yoursite.com</span>

<span class="go">10.10.99.30 www.theirsite.com</span>
</pre></div>
</div>
<p><a class="reference internal" href="../../_images/image251.png"><img alt="image23" src="../../_images/image251.png" style="width: 7.05000in; height: 1.60208in;" /></a></p>
<p>From a terminal window (use Cygwin on Win7 Client Desktop, or go to the c:\curl directory from windows command shell ). Curl will let us do some of the additional testing in later sections.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">curl -k https://10.10.99.30 -H Host:www.mysite.com</span>

<span class="go">&lt;H1&gt; MYSITE.COM &lt;/H1&gt;</span>

<span class="go">curl -k https://10.10.99.30 -H Host:www.theirsite.com</span>

<span class="go">&lt;H1&gt; THEIRSITE.COM &lt;/H1&gt;</span>

<span class="go">curl -k https://10.10.99.30 -H Host:www.yoursite.com</span>

<span class="go">&lt;H1&gt; YOURSITE.COM &lt;/H1&gt;</span>

<span class="go">curl -k https://10.10.99.30/api -H Host:www.mysite.com</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">{</span>
<span class="go">   &quot;web-app&quot;: {</span>
<span class="go">     &quot;servlet&quot;: [</span>
<span class="go">        {</span>
<span class="go">           &quot;servlet-name&quot;: &quot;cofaxCDS&quot;,</span>
<span class="go">           &quot;servlet-class&quot;: &quot;org.cofax.cds.CDSServlet&quot;</span>
<span class="go">        }</span>
<span class="go"> ...</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A bunch of nonsense JSON should be returned.</p>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">curl -k https://10.10.99.30/downloads/ -H &#39;Host:www.mysite.com&#39;</span>
</pre></div>
</div>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Index of /downloads<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This completes Module 1 - Lab 2</p>
</div>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="lab1.html" title="2.1.1. Lab 1: Configure pools and internal virtual servers" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="lab3.html" title="2.1.3. Lab 3: Configure Local Logging For Firewall Events" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>