<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>2.1.5. Lab 5: Provide Firewall Security Policies For CDN Enabled Applications</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="2.1.5. Lab 5: Provide Firewall Security Policies For CDN Enabled Applications"/>
  <meta name="product" content="F5 Firewall Solutions"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2020-01-28 09:36:45"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 Firewall Solutions" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>2.1.5. Lab 5: Provide Firewall Security Policies For CDN Enabled Applications &#8212; F5 Firewall Solutions  documentation</title>
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5_agility_theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/CoveoFullSearch.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/21fb8a09c3.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="2.1.6. Lab 6: Configure HTTP security" href="lab6.html" />
    <link rel="prev" title="2.1.4. Lab 4: Configure A Firewall Policy and Firewall Rules For Each Application" href="lab4.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 Firewall Solutions  </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../class1/class1.html">1. Class 1: AFM – The Data Center Firewall</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../class2.html">2. Advanced Multi-Layer Firewall Protection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class3/class3.html">3. Class - F5 BIG-IP DDoS and DNS DoS Protections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class4/class4.html">4. Flowmon Integrated Out-of-path DDoS Solution</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">2.1.5. Lab 5: Provide Firewall Security Policies For CDN Enabled Applications</a><ul>
<li><a class="reference internal" href="#apply-the-irule-to-the-virtual-server">2.1.5.1. Apply the iRule to the Virtual Server</a></li>
<li><a class="reference internal" href="#validate-snat-function">2.1.5.2. Validate SNAT Function</a></li>
<li><a class="reference internal" href="#solve-for-tcp-issues-with-cdn-networks">2.1.5.3. Solve For TCP Issues With CDN Networks</a></li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">F5 Firewall Solutions</a>
              &gt; <a href="../class2.html">2. Advanced Multi-Layer Firewall Protection</a>
              &gt; <a href="module1.html">2.1. Module 1: F5 Multi-layer Firewall</a>

          <span class="right">
             <a href="../../_sources/class2/module1/lab5.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/f5devcentral/f5-agility-labs-firewall">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="lab-5-provide-firewall-security-policies-for-cdn-enabled-applications">
<h1>2.1.5. Lab 5: Provide Firewall Security Policies For CDN Enabled Applications<a class="headerlink" href="#lab-5-provide-firewall-security-policies-for-cdn-enabled-applications" title="Permalink to this headline">¶</a></h1>
<p>Many enterprise sites have some or all of their content served up by Content Delivery Networks (CDN). This common use case leverages proxies to provide static content closer to the end client machines for performance. Because of this there may only be one or two IP addresses connecting to the origin website. The original IP address of the client in this case is often mapped to a common HTTP header X-Forwarded-For or some variation. In this deployment, the BIG-IP can translate the original source of the request in the XFF to the source IP address.</p>
<p>In this case we are going to leverage iRules to modify the traffic coming from the CDN networks so we can apply a firewall policy to it. The iRule to accomplish this is already installed on your BIG-IP. We need to apply it the External Virtual Server. Here is a sample of the iRule.</p>
<div class="highlight-tcl notranslate"><div class="highlight"><pre><span></span><span class="nv">when</span> HTTP_REQUEST <span class="k">{</span>
   <span class="k">if</span> <span class="k">{</span> <span class="k">[</span><span class="nv">HTTP</span><span class="o">::</span>header exists <span class="s2">&quot;X-Forwarded-For&quot;</span><span class="k">]</span> <span class="k">}</span> <span class="k">{</span>
      <span class="nv">snat</span> <span class="k">[</span><span class="nv">HTTP</span><span class="o">::</span>header X-Forwarded-For<span class="k">]</span>
      <span class="nv">log</span> local0. <span class="k">[</span><span class="nv">HTTP</span><span class="o">::</span>header X-Forwarded-For<span class="k">]</span>
   <span class="k">}</span>
<span class="k">}</span>
</pre></div>
</div>
<p>Examminig the iRule we find that it is called when an HTTP request happens. It then checks to see if the <code class="docutils literal notranslate"><span class="pre">X-Forwarded-For</span></code> header exists (We wouldn’t want to SNAT to a non-existent IP address) and if it does it modifies the source IP address of the request to the IP address provided in the header.</p>
<div class="section" id="apply-the-irule-to-the-virtual-server">
<h2>2.1.5.1. Apply the iRule to the Virtual Server<a class="headerlink" href="#apply-the-irule-to-the-virtual-server" title="Permalink to this headline">¶</a></h2>
<p><strong>Navigation:</strong> Click on the <code class="docutils literal notranslate"><span class="pre">EXT_VIP_10.10.99.30</span></code> virtual server</p>
<p><a class="reference internal" href="../../_images/image461.png"><img alt="image45" src="../../_images/image461.png" style="width: 7.04167in; height: 4.25000in;" /></a></p>
<p><strong>Navigation:</strong> Click Manage under the iRule section</p>
<p><a class="reference internal" href="../../_images/image471.png"><img alt="image46" src="../../_images/image471.png" style="width: 7.04167in; height: 2.81944in;" /></a></p>
<p><strong>Navigation:</strong> Once you have moved the iRule XFF-SNAT over to the Enabled
Section, Click Finished</p>
</div>
<div class="section" id="validate-snat-function">
<h2>2.1.5.2. Validate SNAT Function<a class="headerlink" href="#validate-snat-function" title="Permalink to this headline">¶</a></h2>
<p>To test functionality, we will need to leverage curl from the CLI to insert the X-Forwarded-For header in to the request.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">curl -k https://10.10.99.30/downloads/ -H &#39;Host: www.mysite.com&#39;</span>
</pre></div>
</div>
<p>Expected Result Snippet:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
   <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Index of /downloads<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
   <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>Validate that IP addresses sourced from China are blocked:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">curl -k https://10.10.99.30/downloads/ -H &#39;Host: www.mysite.com&#39; -H &#39;X-Forwarded-For: 1.202.2.1&#39;</span>
</pre></div>
</div>
<p><strong>Expected Result:</strong> The site should now be blocked and eventually timeout</p>
<p>Validate that requests sourced from the X-Forwarded-For IP address of 172.16.99.5 are now allowed.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">curl -k https://10.10.99.30/api -H &#39;Host:www.mysite.com&#39; -H &#39;X-Forwarded-For: 172.16.99.5&#39;</span>
</pre></div>
</div>
<p><strong>Expected Result:</strong></p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">{</span>
<span class="go">  &quot;web-app&quot;: {</span>
<span class="go">    &quot;servlet&quot;: [</span>
<span class="go">    {</span>
<span class="go">    &quot;servlet-name&quot;: &quot;cofaxCDS&quot;,</span>
<span class="go">    &quot;servlet-class&quot;: &quot;org.cofax.cds.CDSServlet&quot;,</span>
</pre></div>
</div>
</div>
<div class="section" id="solve-for-tcp-issues-with-cdn-networks">
<h2>2.1.5.3. Solve For TCP Issues With CDN Networks<a class="headerlink" href="#solve-for-tcp-issues-with-cdn-networks" title="Permalink to this headline">¶</a></h2>
<p>The next step is to solve for the TCP connection issue with CDN providers. While we are provided the originating client IP address, dropping or reseting the connection can be problematic for other users of the application. This solution is accomplished via AFM iRules. The iRule is already provided for you. We need to apply it to the Network Firewall downloads_policy Policy. It still is logged as a drop or reset in the firewall logs. We allow it to be processed slightly further so that a Layer 7 response can be provided.</p>
<p><a class="reference internal" href="../../_images/image481.png"><img alt="image47" src="../../_images/image481.png" style="width: 7.04167in; height: 6.97222in;" /></a></p>
<p><strong>Navigation:</strong> iRule select the AFM_403_Downloads</p>
<p>Validate that denied requests are now responded with a Layer 7 <strong>403 Error</strong> Page.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">curl -k https://10.10.99.30/downloads -H &#39;Host: www.mysite.com&#39; -H &#39;X-Forwarded-For: 1.202.2.1&#39;</span>
</pre></div>
</div>
<p>Expected Result: Instead of the traffic getting dropped, a 403 error
should be returned.</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>403 Forbidden<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
     403 Forbidden Download of Cryptographic Software Is Restricted
  <span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
</div>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">Since a TCP solution would cause disasterous consequences, the HTML error response will traverse the CDN network back only to the originating client. Using a unique error code such as 418 (I Am A Teapot) would allow you to determine that the webserver is likely not the source of the response. It would also allow the CDN network providers to track these error codes. Try to find one that has a sense of humor.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This concludes Module 1 - Lab 5</p>
</div>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="lab4.html" title="2.1.4. Lab 4: Configure A Firewall Policy and Firewall Rules For Each Application" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="lab6.html" title="2.1.6. Lab 6: Configure HTTP security" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>