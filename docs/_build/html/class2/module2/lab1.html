<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>2.2.1. AFM with iRules LX</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="2.2.1. AFM with iRules LX"/>
  <meta name="product" content="F5 Firewall Solutions"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2020-01-28 09:36:45"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 Firewall Solutions" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>2.2.1. AFM with iRules LX &#8212; F5 Firewall Solutions  documentation</title>
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5_agility_theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/CoveoFullSearch.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/21fb8a09c3.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="2.3. Module 3: AFM Protocol Inspection IPS" href="../module3/module3.html" />
    <link rel="prev" title="2.2. Module 2: F5 Dynamic Firewall Rules With iRules LX" href="module2.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 Firewall Solutions  </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../class1/class1.html">1. Class 1: AFM – The Data Center Firewall</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../class2.html">2. Advanced Multi-Layer Firewall Protection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class3/class3.html">3. Class - F5 BIG-IP DDoS and DNS DoS Protections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class4/class4.html">4. Flowmon Integrated Out-of-path DDoS Solution</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">2.2.1. AFM with iRules LX</a><ul>
<li><a class="reference internal" href="#create-the-pool-and-vs">2.2.1.1. Create the Pool and VS</a></li>
<li><a class="reference internal" href="#test-the-virtual-server">2.2.1.2. Test the Virtual Server</a></li>
<li><a class="reference internal" href="#copy-paste-lx-code">2.2.1.3. Copy &amp; Paste LX Code</a></li>
<li><a class="reference internal" href="#create-lx-plug-in">2.2.1.4. Create LX Plug-In</a></li>
<li><a class="reference internal" href="#create-a-new-afm-policy-to-use-this-lx-rule">2.2.1.5. Create a new AFM Policy to use this LX Rule</a></li>
<li><a class="reference internal" href="#test-the-vs-with-the-lx-rule-in-place">2.2.1.6. Test the VS with the LX Rule in Place</a></li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">F5 Firewall Solutions</a>
              &gt; <a href="../class2.html">2. Advanced Multi-Layer Firewall Protection</a>
              &gt; <a href="module2.html">2.2. Module 2: F5 Dynamic Firewall Rules With iRules LX</a>

          <span class="right">
             <a href="../../_sources/class2/module2/lab1.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/f5devcentral/f5-agility-labs-firewall">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="afm-with-irules-lx">
<h1>2.2.1. AFM with iRules LX<a class="headerlink" href="#afm-with-irules-lx" title="Permalink to this headline">¶</a></h1>
<p>Estimated completion time: 15 minutes</p>
<p>Beginning in TMOS 12.1 BIGIP offers iRules LX which is a node.js extension to iRules IRules LX does not replace iRules, rather allows iRules to offer additional functionality. In this lab you see how iRules LX can be used to look up client ip addresses that should be disallowed by AFM.</p>
<p><strong>Note:</strong> You do not need skills or knowledge of iRules LX to do this lab. This lab will not go into detail on iRules LX nor will it go into detail on Node.JS, rather, this lab shows an application of this with AFM.</p>
<p><strong>Note:</strong> We are using a different set of IP subnets just for this module, as shown in this network diagram:</p>
<p><a class="reference internal" href="../../_images/lx_diagram.png"><img alt="image98" src="../../_images/lx_diagram.png" style="width: 7.05000in; height: 3.28750in;" /></a></p>
<p><strong>Note:</strong> You should be comfortable creating pools and virtual servers by now. Therefore, the following steps to create pools, virtual servers, and AFM policies are kept brief and to the point.</p>
<div class="section" id="create-the-pool-and-vs">
<h2>2.2.1.1. Create the Pool and VS<a class="headerlink" href="#create-the-pool-and-vs" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Create a pool named afmmysql_pool with one pool member ip address 172.1.1.10 and port 80, and a tcp half-open monitor. Leave all other values default.</li>
<li>Create a TCP VS named afmmysql_vs with a destination address of 192.168.1.51, port 80, snat Automap, and set it to use the afmmysql_pool pool. Leave all other values default.</li>
</ol>
</div>
<div class="section" id="test-the-virtual-server">
<h2>2.2.1.2. Test the Virtual Server<a class="headerlink" href="#test-the-virtual-server" title="Permalink to this headline">¶</a></h2>
<p>On the Win7 client, use curl in the cygwin cli ( or from the c:\curl directory in a windows command line shell ) to test the Virtual Server.</p>
<p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://192.168.1.51</span> <span class="pre">--connect-timeout</span> <span class="pre">5</span></code></p>
<p>You will notice that you connect, and web page is shown.</p>
<p><img alt="curl_lx_success" src="../../_images/curl_lx_success.png" /></p>
</div>
<div class="section" id="copy-paste-lx-code">
<h2>2.2.1.3. Copy &amp; Paste LX Code<a class="headerlink" href="#copy-paste-lx-code" title="Permalink to this headline">¶</a></h2>
<p><strong>Note:</strong> Dont’ worry, you’re not doing any coding here today.  Just a little copy and paste excersize. You are going to copy two files from the Windows desktop and paste them into the iRules LX workspace.</p>
<ol class="arabic simple">
<li><strong>Navigate:</strong> In the BIG-IP webgui, navigate to Local Traffic-&gt;iRules-&gt; LX Workspaces-&gt; irules_lx_mysql_workspace</li>
<li>Open the mysql_iRulesLx.txt file in Notepad ( located on the Windows Desktop) and copy ( Ctrl-C or use Mouse ) the entire contents</li>
<li>In the Big-IP webgui, Click on rules-&gt;mysql_irulelx</li>
<li>Replace the contents of this with the text you just copied from the mysql_irulesLx.txt file.</li>
<li>Click “Save File”</li>
<li>In Windows, open the index.js file located on the Desktop ( it should open in NotePad ), select all, and copy ( Ctrl-C or use Mouse ) its entire contents.</li>
<li>In the Big-IP gui, click on mysql_extension/index.js. Replace the contents of mysql_extension/index.js with the contents of the index.js that you just copied.</li>
<li>Click “Save File”</li>
</ol>
<p><img alt="lx_workspace.png" src="../../_images/lx_workspace.png" /></p>
</div>
<div class="section" id="create-lx-plug-in">
<h2>2.2.1.4. Create LX Plug-In<a class="headerlink" href="#create-lx-plug-in" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><strong>Navigate:</strong> to Local Traffic-&gt;iRules-&gt; LX Plugins and create a new LX Plugin named “afmmysqlplug” using the workspace (From Workspace dropdown) irules_lx_mysql_workspace.</li>
<li>Click “Finished”</li>
</ol>
<p><img alt="image99" src="../../_images/lx_plug.png" /></p>
</div>
<div class="section" id="create-a-new-afm-policy-to-use-this-lx-rule">
<h2>2.2.1.5. Create a new AFM Policy to use this LX Rule<a class="headerlink" href="#create-a-new-afm-policy-to-use-this-lx-rule" title="Permalink to this headline">¶</a></h2>
<p><strong>Note:</strong> You are assumed to be pretty familiar with creating AFM policies by now, hence the following steps are kept brief and to the point.</p>
<ol class="arabic simple">
<li>Create a new AFM policy named afmmysql_pol</li>
<li>Add a rule named afmmysql_rule and click iRule to assign the “mysql_Irulelx” iRule.</li>
</ol>
<p><img alt="image100" src="../../_images/image148.png" /></p>
<ol class="arabic simple" start="3">
<li>Click “Finished”</li>
<li>Assign this rule to the afmmysql_vs virtual server.</li>
</ol>
</div>
<div class="section" id="test-the-vs-with-the-lx-rule-in-place">
<h2>2.2.1.6. Test the VS with the LX Rule in Place<a class="headerlink" href="#test-the-vs-with-the-lx-rule-in-place" title="Permalink to this headline">¶</a></h2>
<p>On the Win7 client, use curl in the cygwin cli ( or from c:\curl directory in a windows command line shell ) to test that the client is being blocked, as the Win7 client’s ip is in the mysql database.</p>
<p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://192.168.1.51</span> <span class="pre">--connect-timeout</span> <span class="pre">5</span></code></p>
<p>If everything went successfull, this should now timeout.</p>
<div class="admonition attention">
<p class="first admonition-title">Attention</p>
<p class="last">Ensure that the iRule is working properly, by going back to the AFM rule and setting the iRule back to None. Also examine the log files at <code class="docutils literal notranslate"><span class="pre">/var/log/ltm</span></code> on the BIG-Ip ( or look in the GUI Log as shown here )</p>
</div>
<p><img alt="lx_log" src="../../_images/lx_log.png" /></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This completes Module 3 - Lab 1</p>
</div>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="module2.html" title="2.2. Module 2: F5 Dynamic Firewall Rules With iRules LX" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="../module3/module3.html" title="2.3. Module 3: AFM Protocol Inspection IPS" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>