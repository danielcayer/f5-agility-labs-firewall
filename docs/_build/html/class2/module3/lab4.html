<!DOCTYPE html>
<head>
  
  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-PPZPQ6');</script>
  <!-- End Google Tag Manager -->
    <title>2.3.4. Lab 4: Protocol Inspection - Custom Signatures</title>
  

  <meta charset="utf-8">
  <!-- Twitter Bootstrap viewport setting -->
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- F5 metadata -->
  <meta name="title" content="2.3.4. Lab 4: Protocol Inspection - Custom Signatures"/>
  <meta name="product" content="F5 Firewall Solutions"/>
  <meta name="version" content=""/>
  <meta name="updated_date"  content="2020-01-28 09:36:45"/>
  <meta name="archived" content="Archived documents excluded"/>
  <meta name="doc_type" content="Manual"/>
  <meta name="lifecycle" content="release"/>
  <meta name="F5 Firewall Solutions" content=""/>


  

  
  <link href="https://cdn.f5.com/favicon.ico" rel="icon">

</head>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>2.3.4. Lab 4: Protocol Inspection - Custom Signatures &#8212; F5 Firewall Solutions  documentation</title>
    <link rel="stylesheet" href="../../_static/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5_agility_theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/f5-theme.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/CoveoFullSearch.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    <link rel="stylesheet" type="text/css" href="https://use.fontawesome.com/21fb8a09c3.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="3. Class - F5 BIG-IP DDoS and DNS DoS Protections" href="../../class3/class3.html" />
    <link rel="prev" title="2.3.3. Lab 3: Protocol Inspection - Signatures" href="lab3.html" /> 
  </head><body>
  <div id="clouddocs-header"></div>

    <div id="sidebar" class="section-nav">
      
      <!--  version selector ------------------>
      <div id="version_selector_wrapper">
      </div>
      <nav class="nav-sidebartoc">

        
         <h5>F5 Firewall Solutions  </h5>
        

        <hr>
        <span class="nav-sidebartoc">
            <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../class1/class1.html">1. Class 1: AFM – The Data Center Firewall</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../class2.html">2. Advanced Multi-Layer Firewall Protection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class3/class3.html">3. Class - F5 BIG-IP DDoS and DNS DoS Protections</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../class4/class4.html">4. Flowmon Integrated Out-of-path DDoS Solution</a></li>
</ul>

        </span><!-- Use this file to add extra links to the bottom of the ToC sidebar -->
<hr>
  <span class="nav-sidebartoc">
 <!-- insert content here -->
  </span>
      </nav>
    </div>


    <div id="right-sidebar">
      <h7 style="font-weight:normal">On this page:</h7>
      <nav class="nav-sidebartoc">
        <span class="nav-sidebartoc">
            <ul>
<li><a class="reference internal" href="#">2.3.4. Lab 4: Protocol Inspection - Custom Signatures</a><ul>
<li><a class="reference internal" href="#task-1-set-filter">2.3.4.1. Task 1: Set Filter</a></li>
<li><a class="reference internal" href="#task-2-cargo-cult-signature-authoring-finding-an-example-to-copy">2.3.4.2. Task 2: Cargo Cult Signature Authoring - finding an example to copy</a></li>
<li><a class="reference internal" href="#task-3-adapting-our-example-in-creating-a-custom-signature">2.3.4.3. Task 3: Adapting our example in creating a custom signature</a></li>
</ul>
</li>
</ul>

         </span>
      </nav>
    </div>





  
  <div class="main active" id="content" >
    <article class="docs-container site-article-inner">
              <!-- custom breadcrumb -->
        <h5>
            <a href="../../index.html">F5 Firewall Solutions</a>
              &gt; <a href="../class2.html">2. Advanced Multi-Layer Firewall Protection</a>
              &gt; <a href="module3.html">2.3. Module 3: AFM Protocol Inspection IPS</a>

          <span class="right">
             <a href="../../_sources/class2/module3/lab4.rst.txt" rel="nofollow">Source</a> |
             <a href="https://github.com/f5devcentral/f5-agility-labs-firewall">Edit on <i class="fa fa-github" aria-hidden="true"></i></a>
          </span>
        </h5>
        <!-- end custom breadcrumb -->
      


    <!--a title="Export PDF" id="export-pdf" class="btn btn btn-link pull-right">View PDF</a-->
    <button type="button" id="export-pdf" class="btn btn-link right">PDF</button>


    
     
         <div class="sidebar" id="version-warning" style="display: none;">
           <p class="first sidebar-title">
           <span class="icon fa fa-info-circle fa-lg"></span> Version notice:</p>
           <p class="last" id="currentVersion"></p>
          </div>


     <div role="main">
        
  <div class="section" id="lab-4-protocol-inspection-custom-signatures">
<h1>2.3.4. Lab 4: Protocol Inspection - Custom Signatures<a class="headerlink" href="#lab-4-protocol-inspection-custom-signatures" title="Permalink to this headline">¶</a></h1>
<p>Estimated completion time: 15 minutes</p>
<p>You can write custom signatures using a subset of the Snort® rules language. We’ll walk
through a couple of examples, but the intent is not to make you an expert. At most we can give
you a head start in developing expertise.
We’ll start with a scenario: we want to detect sessions requesting a particular URI,
/images/cat.gif where the User-Agent is “Attack-Bot-2000”
When working with signatures, keep in mind there are just under 1600 signatures shipping with
13.1.0. It will be easier to work with custom signatures if you add a filter for them.</p>
<div class="section" id="task-1-set-filter">
<h2>2.3.4.1. Task 1: Set Filter<a class="headerlink" href="#task-1-set-filter" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Edit the Inspection Profile ‘my-inspection-profile’ Click ‘Add Filter’ and select ‘User Defined’</li>
<li>When the User Defined filter is added, select ‘yes’</li>
</ol>
<p><img alt="image1" src="../../_images/lab4-image1.png" /></p>
</div>
<div class="section" id="task-2-cargo-cult-signature-authoring-finding-an-example-to-copy">
<h2>2.3.4.2. Task 2: Cargo Cult Signature Authoring - finding an example to copy<a class="headerlink" href="#task-2-cargo-cult-signature-authoring-finding-an-example-to-copy" title="Permalink to this headline">¶</a></h2>
<p>It’s often more pragmatic to modify an example that is close to what we want than to start from scratch. Let’s start with a very simple example.</p>
<p>From the BIG-IP command line, issue the following command:</p>
<p>grep 1189 /defaults/ips_snort_signatures.txt</p>
<p><strong>Expected output:</strong></p>
<p>alert tcp any any -&gt; any any (content:”/rksh”; fast_pattern:only; http_uri; sig_id:1189;)</p>
<p>Parsing this, there is a Header section and an Options section. The Header is the stuff outside the parenthesis:</p>
<p>alert means “match” or “do something.” The BIG-IP/AFM Inspection Policy will actually determine what is done with a packet that matches a signature, so it doesn’t matter which action you choose. For the greatest clarity, standardize on “alert” so you don’t confuse others or yourself.</p>
<p>tcp is the L4 protocol. The Signature has a Protocol setting outside the signature definition. They should probably agree, don’t you think?</p>
<p>any any -&gt; any any means “FROM any source IP+port TO any destination IP+port.” We will tighten this up in a later lab procedure. Note that the signature has its own direction outside the signature definition. We probably want to avoid a conflict between these direction settings.</p>
<p>The Options are the elements inside the parenthesis. Each option is a Type: value pair, separated by a colon. Each Option is separated by a semicolon. The options in this example are:</p>
<ul class="simple">
<li>content - This is the pattern to match, in this case “/rksh.”</li>
<li>fast_pattern - applies to the previous content definition. It’s intended to be used to prequalify a rule for further processing. If you have a bunch of expensive content checks, you can look for one characteristic string to see if you need to bother with the others. In this example the effective meaning is “If you see this, look into the other content to see if we match” but there’s no other content! The key takeaway is that the rules provided are not optimized. We’ll try to do better when we create our own.</li>
<li>http_uri - also applies to the previous content definition. It restricts the search to the HTTP Uniform Resource Identifier.</li>
<li>sig_id - the signature id</li>
</ul>
</div>
<div class="section" id="task-3-adapting-our-example-in-creating-a-custom-signature">
<h2>2.3.4.3. Task 3: Adapting our example in creating a custom signature<a class="headerlink" href="#task-3-adapting-our-example-in-creating-a-custom-signature" title="Permalink to this headline">¶</a></h2>
<p>We’re going to run into a problem that stems from MCPD parsing the contents of /defaults/ips_snort_signatures.txt differently than the UI parses custom signatures.</p>
<ol class="arabic simple">
<li>Create a new custom signature. Navigate to Security &gt; Protocol Security &gt; Inspection List and click “New Signature”</li>
</ol>
<p><img alt="image2" src="../../_images/lab4-image2.png" /></p>
<ol class="arabic simple" start="2">
<li>Enter the following:</li>
</ol>
<p>a.Name - this is an odd field in that it doesn’t show up in the
Signatures page but it is the object name in the config.</p>
<p>Enter “no cat gif”</p>
<ol class="loweralpha simple" start="2">
<li>Description - this <em>does</em> show up in the Signatures page, Event Logs, tmsh show output, etc. Make it descriptive, systematic, and concise. Enter “HTTP cat.gif request”</li>
<li>Signature Definition - here’s the big one. Based on our example, enter:</li>
</ol>
<p>alert tcp any any -&gt; any 80 (content:cat.gif;http_uri; sig_id:100000;)</p>
<p>This simply swaps the content URI string to match and provides a new signature ID.</p>
<ol class="loweralpha simple" start="4">
<li>Click “Create.” We expect configuration validation to succeed.</li>
</ol>
<p>From the Signatures page, open your new signature up for editing to add the rest of the signature elements.</p>
<ol class="loweralpha simple" start="5">
<li>Direction: to Server (agreeing with our signature definition)</li>
<li>Protocol: TCP (agreeing with our signature definition)</li>
<li>Attack type - “cat gifs”</li>
<li>Service - select HTTP</li>
<li>Click “Save”</li>
</ol>
<p><img alt="image3" src="../../_images/catgif.png" /></p>
<ol class="arabic simple" start="3">
<li>Add this signature to the Inspection Profile my-inspection-profile</li>
</ol>
<ul class="simple">
<li>Navigate to Security &gt; Protocol Security &gt; Inspection Profiles &gt; my-inspectionprofile</li>
<li>Select your new signature, 100000, and when the “Edit Inspections” window pops open, set “Action” to “Reject” and click “Apply” (“Enable” and Log: Yes are selected by default.)</li>
</ul>
<p><img alt="catgif3" src="../../_images/catgif3.png" />
<img alt="catgif2" src="../../_images/catgif2.png" /></p>
<ol class="loweralpha simple" start="3">
<li>Click “Commit Changes to Profile”</li>
</ol>
<ol class="arabic simple" start="4">
<li>Test it out.</li>
</ol>
<ol class="loweralpha simple">
<li>From the Desktop terminal, use the following command:</li>
</ol>
<p>curl -A test <a class="reference external" href="http://10.10.99.40/cat.gif">http://10.10.99.40/cat.gif</a></p>
<ol class="loweralpha simple" start="2">
<li>Check stats. From the BIG-IP command line:</li>
</ol>
<p>tmsh show sec proto profile my-inspection-profile</p>
<p>We expect to see a Hit Count of 1 for Inspection ID 100000.</p>
<p><img alt="catgif99" src="../../_images/catgif99.png" /></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This completes Module 4 - Lab 4</p>
</div>
</div>
</div>


     </div>
    
     <div class="row next-prev-btn-row">
       <div class="col-lg-12">
       
        <a href="lab3.html" title="2.3.3. Lab 3: Protocol Inspection - Signatures" accesskey="p" class="btn btn-primary left"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i> Previous</a>
       
       
          <a href="../../class3/class3.html" title="3. Class - F5 BIG-IP DDoS and DNS DoS Protections" accesskey="n" class="btn btn-primary right">Next <i class="fa fa-arrow-circle-right" aria-hidden="true"></i></a>
       
     </div>
     </div>
    

    </article>
  </div>

</div>


  <div id="clouddocs-footer"></div>
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->

  <script src="../../_static/js/index.js"></script>
  <script src="../../_static/js/jquery.appear.js"></script>
  <script src="../../_static/js/printThis.js"></script>
  <script src="../../_static/js/bootstrap.min.js"></script>
  <script src="../../_static/js/clouddocs.js"></script>
  <script src="../../_static/js/CoveoJsSearch.Lazy.min.js"></script>
  </body>
</html>